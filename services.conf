# /etc/systemd/system/financial-ml-ingestion.service
# Data ingestion service for Financial ML Pipeline
# Optimized for Hetzner Cloud (4 vCPU, 8GB RAM)

[Unit]
Description=Financial ML Data Ingestion Service
Documentation=https://github.com/your-repo/financial-ml-pipeline
After=network-online.target
Wants=network-online.target
StartLimitIntervalSec=300
StartLimitBurst=5

[Service]
Type=simple
User=financial_ml
Group=financial_ml
WorkingDirectory=/opt/financial_ml
ExecStart=/opt/financial_ml/venv/bin/python -m data_ingestion
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=10

# Logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=financial-ml-ingestion

# Security settings
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/financial_ml/data
ReadWritePaths=/var/log/financial_ml
PrivateTmp=true
ProtectControlGroups=true
ProtectKernelModules=true
ProtectKernelTunables=true

# Resource limits for Hetzner CPX21 (4 vCPU, 8GB)
MemoryLimit=4G
CPUQuota=200%
TasksMax=200

# Environment
Environment=PYTHONPATH=/opt/financial_ml
Environment=PYTHONUNBUFFERED=1
Environment=CONFIG_PATH=/opt/financial_ml/config.yaml

# Watchdog
WatchdogSec=300
NotifyAccess=main

[Install]
WantedBy=multi-user.target

---

# /etc/systemd/system/financial-ml-training.service
# Model training service

[Unit]
Description=Financial ML Training Service
After=financial-ml-ingestion.service
Requires=financial-ml-ingestion.service

[Service]
Type=oneshot
User=financial_ml
Group=financial_ml
WorkingDirectory=/opt/financial_ml
ExecStart=/opt/financial_ml/venv/bin/python -m ml_pipeline --mode train --symbol BTC/USD --bar-type dollar
StandardOutput=journal
StandardError=journal
TimeoutSec=7200
MemoryLimit=6G
CPUQuota=400%

Environment=PYTHONPATH=/opt/financial_ml
Environment=PYTHONUNBUFFERED=1
Environment=CONFIG_PATH=/opt/financial_ml/config.yaml

[Install]
WantedBy=multi-user.target

---

# /etc/systemd/system/financial-ml-training.timer
# Timer for model training (daily at 2 AM)

[Unit]
Description=Run Financial ML Training Daily
Requires=financial-ml-training.service

[Timer]
OnCalendar=*-*-* 02:00:00
Persistent=true
RandomizedDelaySec=300

[Install]
WantedBy=timers.target

---

# /etc/systemd/system/financial-ml-discovery.service
# Strategy discovery service

[Unit]
Description=Financial ML Strategy Discovery Service
After=financial-ml-training.service

[Service]
Type=oneshot
User=financial_ml
Group=financial_ml
WorkingDirectory=/opt/financial_ml
ExecStart=/opt/financial_ml/venv/bin/python -m strategy_discovery discover --symbols BTC/USD,ETH/USD --timeframe algorithmic
StandardOutput=journal
StandardError=journal
TimeoutSec=14400
MemoryLimit=6G
CPUQuota=400%

Environment=PYTHONPATH=/opt/financial_ml
Environment=PYTHONUNBUFFERED=1
Environment=CONFIG_PATH=/opt/financial_ml/config.yaml

[Install]
WantedBy=multi-user.target

---

# /etc/systemd/system/financial-ml-discovery.timer
# Timer for strategy discovery (weekly on Sunday at 3 AM)

[Unit]
Description=Run Financial ML Strategy Discovery Weekly
Requires=financial-ml-discovery.service

[Timer]
OnCalendar=Sun *-*-* 03:00:00
Persistent=true
RandomizedDelaySec=600

[Install]
WantedBy=timers.target

---

# /etc/systemd/system/financial-ml-signals.service
# Signal generation service

[Unit]
Description=Financial ML Signal Generation Service
After=financial-ml-ingestion.service
Requires=financial-ml-ingestion.service

[Service]
Type=oneshot
User=financial_ml
Group=financial_ml
WorkingDirectory=/opt/financial_ml
ExecStart=/opt/financial_ml/venv/bin/python -m strategy_discovery signals --symbols BTC/USD,ETH/USD
StandardOutput=journal
StandardError=journal
TimeoutSec=600
MemoryLimit=2G

Environment=PYTHONPATH=/opt/financial_ml
Environment=PYTHONUNBUFFERED=1
Environment=CONFIG_PATH=/opt/financial_ml/config.yaml

[Install]
WantedBy=multi-user.target

---

# /etc/systemd/system/financial-ml-signals.timer
# Timer for signal generation (every hour)

[Unit]
Description=Run Financial ML Signal Generation Hourly
Requires=financial-ml-signals.service

[Timer]
OnCalendar=*-*-* *:00:00
Persistent=true
RandomizedDelaySec=60

[Install]
WantedBy=timers.target

---

# /etc/systemd/system/financial-ml-backup.service
# Backup service

[Unit]
Description=Financial ML Backup Service

[Service]
Type=oneshot
User=financial_ml
Group=financial_ml
WorkingDirectory=/opt/financial_ml
ExecStart=/opt/financial_ml/scripts/backup.sh
StandardOutput=journal
StandardError=journal
TimeoutSec=1800

[Install]
WantedBy=multi-user.target

---

# /etc/systemd/system/financial-ml-backup.timer
# Timer for backups (daily at 4 AM)

[Unit]
Description=Run Financial ML Backup Daily
Requires=financial-ml-backup.service

[Timer]
OnCalendar=*-*-* 04:00:00
Persistent=true

[Install]
WantedBy=timers.target
