# Financial ML Pipeline Configuration
# Optimized for Raspberry Pi 5 8GB

# System Configuration
system:
  max_memory_usage: 6.0  # GB - Leave 2GB for OS
  max_cpu_cores: 3       # Use 3 of 4 cores
  log_level: "INFO"
  log_file: "/var/log/financial_ml/pipeline.log"
  pid_file: "/var/run/financial_ml.pid"

# Database Configuration
database:
  type: "sqlite"  # Options: sqlite, timescaledb
  sqlite:
    path: "/opt/financial_ml/data/financial_data.db"
    journal_mode: "WAL"  # Better for concurrent access
    synchronous: "NORMAL"  # Balance between safety and speed
    cache_size: 100000  # 100MB cache
  # Future TimescaleDB config
  timescaledb:
    host: "localhost"
    port: 5432
    database: "financial_ml"
    username: "pi"
    password: "your_password"
    pool_size: 5

# Data Ingestion Configuration
data_ingestion:
  # Kraken WebSocket settings
  websocket:
    uri: "wss://ws.kraken.com/v2"
    reconnect_delay: 5.0
    max_reconnect_attempts: 10
    ping_interval: 30
    ping_timeout: 10

  # Trading pairs to monitor
  symbols:
    algorithmic:  # High-frequency (minute-level) trading
      - "BTC/USD"
      - "ETH/USD"
    swing:  # Daily-level trading
      - "BTC/USD"
      - "ETH/USD"
      - "ADA/USD"
      - "DOT/USD"

  # Bar construction settings
  bars:
    algorithmic:
      tick: 500           # 500 ticks per bar
      volume: 5.0         # 5 BTC volume per bar
      dollar: 50000       # $50k per dollar bar
      dollar_imbalance: 25000  # $25k imbalance threshold
    swing:
      tick: 5000          # 5000 ticks per bar  
      volume: 50.0        # 50 BTC volume per bar
      dollar: 500000      # $500k per dollar bar
      dollar_imbalance: 250000  # $250k imbalance threshold

  # Event detection
  cusum_filter:
    algorithmic_threshold: 0.005  # 0.5% price movement
    swing_threshold: 0.02         # 2% price movement

  # Storage settings
  storage:
    batch_size: 100
    flush_interval: 30  # seconds
    max_memory_buffer: 10000  # max bars in memory

# Feature Engineering Configuration
feature_engineering:
  # Fractional differentiation
  fractional_diff:
    max_d: 1.0
    step: 0.05
    threshold: 1e-5
    min_samples: 50

  # Technical indicators
  indicators:
    rsi_window: 14
    bollinger_window: 20
    bollinger_std: 2.0
    volume_ma_window: 20
    volatility_window: 20
    
  # Lookback periods for features
  lookback_periods: [5, 10, 20, 50]

# Labeling Configuration  
labeling:
  # Triple barrier method
  triple_barrier:
    profit_taking_factor: 1.0
    stop_loss_factor: 1.0
    min_target_return: 0.005  # 0.5% minimum target
    max_holding_period_hours: 24
    
  # Meta-labeling (buy-only constraint)
  meta_labeling:
    enabled: true
    primary_model: "trend_following"  # Options: trend_following, mean_reversion
    
  # Volatility estimation
  volatility:
    span: 100  # EWMA span for daily volatility

# Sample Weighting Configuration
sample_weighting:
  uniqueness:
    enabled: true
    min_uniqueness: 0.01
  return_attribution:
    enabled: true
  time_decay:
    enabled: true
    decay_factor: 0.95

# Cross-Validation Configuration
cross_validation:
  method: "purged_kfold"
  n_splits: 5
  embargo_pct: 0.02  # 2% embargo
  min_train_samples: 100

# Machine Learning Configuration
machine_learning:
  # Model selection
  models:
    random_forest:
      n_estimators: 500  # Reduced for Pi performance
      max_features: 1
      max_depth: 10
      min_samples_split: 10
      class_weight: "balanced"
      n_jobs: 2  # Limit parallel jobs
      
    bagging:
      n_estimators: 200
      max_samples: 0.8
      max_features: 1.0
      
  # Feature importance
  feature_importance:
    methods: ["mdi", "mda"]  # Skip SFI for performance
    top_n_features: 20
    
  # Hyperparameter tuning
  hyperparameter_tuning:
    enabled: false  # Disable for initial runs on Pi
    method: "random_search"  # Less intensive than grid search
    n_iter: 50
    cv_folds: 3

# Strategy Discovery Configuration
strategy_discovery:
  # Minimum requirements for strategy validation
  minimum_requirements:
    min_samples: 500
    min_cv_score: 0.55
    min_feature_importance: 0.05
    
  # Strategy types to explore
  strategy_types:
    - "momentum"
    - "mean_reversion"
    - "breakout"
    - "volatility"
    
  # Risk management
  risk_management:
    max_position_size: 0.1  # 10% of capital per trade
    max_daily_trades: 5
    max_drawdown: 0.05      # 5% max drawdown
    kelly_fraction: 0.25    # Conservative Kelly sizing
    
  # Signal generation
  signals:
    confidence_threshold: 0.6  # Minimum prediction confidence
    hold_time_hours: 2         # Minimum hold time
    cooldown_hours: 1          # Time between trades on same asset

# Monitoring Configuration
monitoring:
  # System monitoring
  system_monitoring:
    check_interval: 60  # seconds
    memory_alert_threshold: 0.9
    cpu_alert_threshold: 0.8
    disk_alert_threshold: 0.9
    
  # Performance monitoring
  performance_monitoring:
    track_latency: true
    track_throughput: true
    save_metrics_interval: 300  # 5 minutes
    
  # Health checks
  health_checks:
    websocket_timeout: 60
    database_timeout: 30
    model_prediction_timeout: 10

# Scheduling Configuration
scheduling:
  data_ingestion:
    mode: "service"  # Run as systemd service
    restart_policy: "always"
    
  feature_engineering:
    mode: "cron"
    schedule: "0 */4 * * *"  # Every 4 hours
    
  model_training:
    mode: "cron" 
    schedule: "0 2 * * *"   # Daily at 2 AM
    
  strategy_discovery:
    mode: "manual"  # Run on demand
    
# Paths Configuration
paths:
  base_dir: "/opt/financial_ml"
  data_dir: "/opt/financial_ml/data"
  models_dir: "/opt/financial_ml/models"
  logs_dir: "/var/log/financial_ml"
  cache_dir: "/tmp/financial_ml"
  
# Development/Testing Configuration
development:
  debug_mode: false
  save_intermediate_results: true
  mock_trading: true  # Set to false for live trading
  paper_trading_balance: 10000  # USD

# Raspberry Pi Optimizations
raspberry_pi:
  # CPU optimizations
  cpu_affinity: [1, 2, 3]  # Use cores 1-3, leave 0 for system
  nice_level: 5  # Lower priority than system processes
  
  # Memory optimizations
  enable_swap: false  # Avoid swap on SD card
  memory_mapped_files: true
  gc_threshold: [100, 10, 10]  # More frequent garbage collection
  
  # Storage optimizations
  batch_writes: true
  compression: "lz4"  # Fast compression for logs
  
  # Temperature monitoring
  thermal_throttle_temp: 75  # Celsius
  thermal_shutdown_temp: 85