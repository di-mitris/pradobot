# =============================================================================
# Financial ML Pipeline - Systemd Service Definitions
# Optimized for Hetzner Cloud (4 vCPU, 8GB RAM)
# =============================================================================
# 
# This file contains all systemd service and timer definitions.
# The deploy.sh script will split this into individual files.
#
# Services are organized into two separate pipelines:
#   - Algorithmic: High-frequency trading (minute-level)
#   - Swing: Position trading (daily-level)
#
# =============================================================================

# =============================================================================
# CORE SERVICE: Data Ingestion (Shared by both pipelines)
# =============================================================================

### FILE: financial-ml-ingestion.service ###
[Unit]
Description=Financial ML Data Ingestion Service
Documentation=https://github.com/your-repo/financial-ml-pipeline
After=network-online.target
Wants=network-online.target
StartLimitIntervalSec=300
StartLimitBurst=5

[Service]
Type=simple
User=financial_ml
Group=financial_ml
WorkingDirectory=/opt/financial_ml
ExecStart=/opt/financial_ml/venv/bin/python -m data_ingestion
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=10

# Logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=financial-ml-ingestion

# Security settings
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/financial_ml/data
ReadWritePaths=/var/log/financial_ml
PrivateTmp=true
ProtectControlGroups=true
ProtectKernelModules=true
ProtectKernelTunables=true

# Resource limits for Hetzner CPX21 (4 vCPU, 8GB)
MemoryLimit=4G
CPUQuota=200%
TasksMax=200

# Environment
Environment=PYTHONPATH=/opt/financial_ml
Environment=PYTHONUNBUFFERED=1
Environment=CONFIG_PATH=/etc/financial_ml/config.yaml

# Watchdog
WatchdogSec=300
NotifyAccess=main

[Install]
WantedBy=multi-user.target

# =============================================================================
# ALGORITHMIC PIPELINE: High-frequency trading
# Training: Daily at 2 AM
# Signals: Hourly
# Discovery: Weekly Sunday 3 AM
# =============================================================================

### FILE: financial-ml-training-algo.service ###
[Unit]
Description=Financial ML Algorithmic Training Service
Documentation=https://github.com/your-repo/financial-ml-pipeline
After=financial-ml-ingestion.service
Wants=financial-ml-ingestion.service

[Service]
Type=oneshot
User=financial_ml
Group=financial_ml
WorkingDirectory=/opt/financial_ml
ExecStart=/opt/financial_ml/venv/bin/python -m ml_pipeline --mode train --symbol BTC/USD --bar-type dollar --timeframe algorithmic
StandardOutput=journal
StandardError=journal
SyslogIdentifier=financial-ml-training-algo
TimeoutSec=7200
MemoryLimit=6G
CPUQuota=400%

Environment=PYTHONPATH=/opt/financial_ml
Environment=PYTHONUNBUFFERED=1
Environment=CONFIG_PATH=/etc/financial_ml/config.yaml

[Install]
WantedBy=multi-user.target

### FILE: financial-ml-training-algo.timer ###
[Unit]
Description=Run Financial ML Algorithmic Training Daily
Documentation=https://github.com/your-repo/financial-ml-pipeline

[Timer]
OnCalendar=*-*-* 02:00:00
Persistent=true
RandomizedDelaySec=300

[Install]
WantedBy=timers.target

### FILE: financial-ml-signals-algo.service ###
[Unit]
Description=Financial ML Algorithmic Signal Generation Service
Documentation=https://github.com/your-repo/financial-ml-pipeline
After=financial-ml-ingestion.service
Wants=financial-ml-ingestion.service

[Service]
Type=oneshot
User=financial_ml
Group=financial_ml
WorkingDirectory=/opt/financial_ml
ExecStart=/opt/financial_ml/venv/bin/python -m strategy_discovery signals --symbols BTC/USD,ETH/USD --timeframe algorithmic
StandardOutput=journal
StandardError=journal
SyslogIdentifier=financial-ml-signals-algo
TimeoutSec=600
MemoryLimit=2G

Environment=PYTHONPATH=/opt/financial_ml
Environment=PYTHONUNBUFFERED=1
Environment=CONFIG_PATH=/etc/financial_ml/config.yaml

[Install]
WantedBy=multi-user.target

### FILE: financial-ml-signals-algo.timer ###
[Unit]
Description=Run Financial ML Algorithmic Signal Generation Hourly
Documentation=https://github.com/your-repo/financial-ml-pipeline

[Timer]
OnCalendar=*-*-* *:00:00
Persistent=true
RandomizedDelaySec=60

[Install]
WantedBy=timers.target

### FILE: financial-ml-discovery-algo.service ###
[Unit]
Description=Financial ML Algorithmic Strategy Discovery Service
Documentation=https://github.com/your-repo/financial-ml-pipeline
After=financial-ml-training-algo.service

[Service]
Type=oneshot
User=financial_ml
Group=financial_ml
WorkingDirectory=/opt/financial_ml
ExecStart=/opt/financial_ml/venv/bin/python -m strategy_discovery discover --symbols BTC/USD,ETH/USD --timeframe algorithmic
StandardOutput=journal
StandardError=journal
SyslogIdentifier=financial-ml-discovery-algo
TimeoutSec=14400
MemoryLimit=6G
CPUQuota=400%

Environment=PYTHONPATH=/opt/financial_ml
Environment=PYTHONUNBUFFERED=1
Environment=CONFIG_PATH=/etc/financial_ml/config.yaml

[Install]
WantedBy=multi-user.target

### FILE: financial-ml-discovery-algo.timer ###
[Unit]
Description=Run Financial ML Algorithmic Strategy Discovery Weekly
Documentation=https://github.com/your-repo/financial-ml-pipeline

[Timer]
OnCalendar=Sun *-*-* 03:00:00
Persistent=true
RandomizedDelaySec=600

[Install]
WantedBy=timers.target

# =============================================================================
# SWING PIPELINE: Position trading
# Training: Weekly Wednesday at 3 AM (offset from algo discovery)
# Signals: Daily at 6 AM (after overnight data)
# Discovery: Monthly 1st Sunday at 4 AM
# =============================================================================

### FILE: financial-ml-training-swing.service ###
[Unit]
Description=Financial ML Swing Training Service
Documentation=https://github.com/your-repo/financial-ml-pipeline
After=financial-ml-ingestion.service
Wants=financial-ml-ingestion.service

[Service]
Type=oneshot
User=financial_ml
Group=financial_ml
WorkingDirectory=/opt/financial_ml
ExecStart=/opt/financial_ml/venv/bin/python -m ml_pipeline --mode train --symbol BTC/USD --bar-type dollar --timeframe swing
StandardOutput=journal
StandardError=journal
SyslogIdentifier=financial-ml-training-swing
TimeoutSec=10800
MemoryLimit=6G
CPUQuota=400%

Environment=PYTHONPATH=/opt/financial_ml
Environment=PYTHONUNBUFFERED=1
Environment=CONFIG_PATH=/etc/financial_ml/config.yaml

[Install]
WantedBy=multi-user.target

### FILE: financial-ml-training-swing.timer ###
[Unit]
Description=Run Financial ML Swing Training Weekly
Documentation=https://github.com/your-repo/financial-ml-pipeline

[Timer]
OnCalendar=Wed *-*-* 03:00:00
Persistent=true
RandomizedDelaySec=600

[Install]
WantedBy=timers.target

### FILE: financial-ml-signals-swing.service ###
[Unit]
Description=Financial ML Swing Signal Generation Service
Documentation=https://github.com/your-repo/financial-ml-pipeline
After=financial-ml-ingestion.service
Wants=financial-ml-ingestion.service

[Service]
Type=oneshot
User=financial_ml
Group=financial_ml
WorkingDirectory=/opt/financial_ml
ExecStart=/opt/financial_ml/venv/bin/python -m strategy_discovery signals --symbols BTC/USD,ETH/USD,ADA/USD,DOT/USD --timeframe swing
StandardOutput=journal
StandardError=journal
SyslogIdentifier=financial-ml-signals-swing
TimeoutSec=900
MemoryLimit=2G

Environment=PYTHONPATH=/opt/financial_ml
Environment=PYTHONUNBUFFERED=1
Environment=CONFIG_PATH=/etc/financial_ml/config.yaml

[Install]
WantedBy=multi-user.target

### FILE: financial-ml-signals-swing.timer ###
[Unit]
Description=Run Financial ML Swing Signal Generation Daily
Documentation=https://github.com/your-repo/financial-ml-pipeline

[Timer]
OnCalendar=*-*-* 06:00:00
Persistent=true
RandomizedDelaySec=300

[Install]
WantedBy=timers.target

### FILE: financial-ml-discovery-swing.service ###
[Unit]
Description=Financial ML Swing Strategy Discovery Service
Documentation=https://github.com/your-repo/financial-ml-pipeline
After=financial-ml-training-swing.service

[Service]
Type=oneshot
User=financial_ml
Group=financial_ml
WorkingDirectory=/opt/financial_ml
ExecStart=/opt/financial_ml/venv/bin/python -m strategy_discovery discover --symbols BTC/USD,ETH/USD,ADA/USD,DOT/USD --timeframe swing
StandardOutput=journal
StandardError=journal
SyslogIdentifier=financial-ml-discovery-swing
TimeoutSec=21600
MemoryLimit=6G
CPUQuota=400%

Environment=PYTHONPATH=/opt/financial_ml
Environment=PYTHONUNBUFFERED=1
Environment=CONFIG_PATH=/etc/financial_ml/config.yaml

[Install]
WantedBy=multi-user.target

### FILE: financial-ml-discovery-swing.timer ###
[Unit]
Description=Run Financial ML Swing Strategy Discovery Monthly
Documentation=https://github.com/your-repo/financial-ml-pipeline

[Timer]
# First Sunday of each month at 4 AM
OnCalendar=Sun *-*-1..7 04:00:00
Persistent=true
RandomizedDelaySec=600

[Install]
WantedBy=timers.target

# =============================================================================
# MAINTENANCE SERVICES: Backup and Health Check
# =============================================================================

### FILE: financial-ml-backup.service ###
[Unit]
Description=Financial ML Backup Service
Documentation=https://github.com/your-repo/financial-ml-pipeline

[Service]
Type=oneshot
User=financial_ml
Group=financial_ml
WorkingDirectory=/opt/financial_ml
ExecStart=/opt/financial_ml/scripts/backup.sh
StandardOutput=journal
StandardError=journal
SyslogIdentifier=financial-ml-backup
TimeoutSec=1800

[Install]
WantedBy=multi-user.target

### FILE: financial-ml-backup.timer ###
[Unit]
Description=Run Financial ML Backup Daily
Documentation=https://github.com/your-repo/financial-ml-pipeline

[Timer]
OnCalendar=*-*-* 04:00:00
Persistent=true

[Install]
WantedBy=timers.target

### FILE: financial-ml-health.service ###
[Unit]
Description=Financial ML Health Check Service
Documentation=https://github.com/your-repo/financial-ml-pipeline

[Service]
Type=oneshot
User=financial_ml
Group=financial_ml
WorkingDirectory=/opt/financial_ml
ExecStart=/opt/financial_ml/scripts/health-check.sh
StandardOutput=journal
StandardError=journal
SyslogIdentifier=financial-ml-health
TimeoutSec=60

[Install]
WantedBy=multi-user.target

### FILE: financial-ml-health.timer ###
[Unit]
Description=Run Financial ML Health Check Every 5 Minutes
Documentation=https://github.com/your-repo/financial-ml-pipeline

[Timer]
OnCalendar=*:0/5
Persistent=false

[Install]
WantedBy=timers.target
